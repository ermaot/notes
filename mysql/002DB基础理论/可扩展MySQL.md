## 什么是可扩展
- 可扩展性是当我们需要增加资源以执行更多工作时系统能够获得划算的同等提升的能力
- 可扩展性是能够通过增加资源来提升容量的能力
- 包括几个方面
1. 数据量：应用所能累计的数据量是可扩展性最普遍的挑战
2. 用户量。更多的用户意味着更多的事务，以及更多的关联（次方级增长）
3. 用户活跃度
4. 相关数据集的大小
#### 可扩展的正式定义
- 大多数系统只能以比线性扩展略低的扩展系统进行扩展，越高的扩展系统会导致越大的线性偏差
- 多数系统最终会到达一个最大的吞吐量临界点，超过之后反而吞吐下降
- 可扩展性定律（universal scalability law，USL）可通过两个因素建立模型：无法并发执行的一部分工作，以及需要交互的另外一部分工作
- 第一个因素建模则有amdahl定律（amdahl扩展），它导致吞吐量趋于平缓
- 第二个因素，导致USL扩展。内部节点间或者进程间通信大家取决于通信信道的数量，信道数量按照系统内节点数量二次方增长
- USL是一个框架，并非真实系统，但揭示了可扩展性的重要原则：系统内尽量避免串行化和交互
- 评估一个系统并使用回归来确定串行和交互的数量，并作为容量规划和性能评估的最优上线
![线性扩展、amdahl扩展，usl扩展](pic/%E5%8F%AF%E6%89%A9%E5%B1%95MySQL1.png)
## 可扩展MySQL
#### 规划可扩展性
- 规划可扩展性最困难的是估算负载到底是多少（至少数量级要正确）
- 大致正确估算时间点
#### 为扩展赢得时间
扩展应用时必须做一些妥协，准备工作如下：
- 优化性能。很多时候可以通过一些简单的改动来获得明显的性能提升，但收益会递减然后达到成本收益平衡点
- 购买性能更强的硬件：购买更多的服务器或者增加内存
#### 向上扩展
- 向上扩展即垂直扩展，意味着购买更多性能强悍的硬件
- 选择比较新的MySQL版本（MySQL5.5以上或者percona server 5.1以上），能对大型硬件更好的支持
- MySQL的收益递减点机器配置大约是256GB内存，32核cpu以及一个PCIe flash驱动器
- 向上扩展策略有天花板，财务上也不一定划算
#### 向外扩展
- 向外扩展也称横向扩展或者水平扩展。可以分为三个部分：复制、拆分、数据分片
- 最简单和常见的向外扩展方法是通过复制将数据发到多个服务器上，然后将备库用于读。以读为主的系统很有效
- 另外的方法是将工作负载分布到多个节点，具体如何分布有很多策略
- 节点的结构可能是：
1. 一个主-主复制双击结构，拥有一个主动服务器和被动服务器
2. 一个主库和多个备库
3. 一个主动服务器，并使用分布式复制块设备（DRBD）作为备用服务器
4. 一个基于存储区域网络（SAN）的集群
- 按功能拆分：按职责拆分，不同的节点执行不同的任务
![image](pic/%E5%8F%AF%E6%89%A9%E5%B1%95MySQL2.png)

不能通过功能拆分做无限扩展，功能拆分往往会导致只能垂直扩展，始终有上限；如果进行了太多的功能划分，以后就很难采用更具扩展性的设计
- 数据分片：目前大型MySQL应用方案中，数据分片是最通用且最成功的方法。把数据分割成一小片，然后存储到不同的节点中
- 大多数应用只对需要的数据分片，而且要根据数据量预估哪些数据需要被分片
- 应用设计初期就需要预计到分片，实现起来更容易
- 采取分片的应用常会有一个数据访问抽象层，用以降低应用和分片数据存储之间的通信复杂度
#### 通过多实例扩展
- 一个分片较多的架构可能会更有效利用硬件
- MySQL并不能完全发挥现代硬件的性能。当扩展到24核心cpu或超过128G内存，MySQL性能区域平缓；MySQL不能完全发挥注入virident或fusion-io卡这样高端的PCIe flash设备的IO性能
- 因此不在一台性能强悍的服务器上只运行一个服务器实例，而让数据分片变小每个机器放置多个分片
#### 通过集群扩展
- NDB cluster：包括NDB数据库，以及作为SQL前端的MySQL存储引擎
1. NDB是一个分布式、具备容错性、非共享的数据库,提供同步复制以及节点间的数据自动分片
2. NDB Cluset存储引擎将SQL转换为NDBAPI调用,但遇到NDB不支持的操作时,就会在MySQL服务器上执行(NDB是一个键—值数据存储,无法执行类似联接或聚合的复杂操作).
3. 可以把NDB当作一个独立的键值数据库，亮点是非常高的写入和查询吞吐
4. NDB复杂查询支持不是很好
5. NDB是事务型系统，但不支持MVCC，也没有死锁检测
- CLustrix
1. 分布式数据库，支持MySQL协议，可直接代替MySQL
2. 完全支持ACID，支持MVCC和事务，应用于OLTP
3. clustrix在节点见进行数据分片，并对查询进行分发
- scalebase
- GenieDB
- Akiban
#### 向内扩展
- 处理不断增长的数据和负载最简单的办法是清理和归档不再需要的数据
- 归档和清理需要注意：
1. 对应用的影响：高效找到要删除的行，然后一小块一小块删除；平衡归档和清理任务与事务处理
2. 维护数据一致性
3. 避免数据丢失
4. 解除归档
4. percona的pt-archiver工具
## 负载均衡
- 负载均衡基本思路：在一个服务器集群中尽可能平均负载量
- 通常做法是在服务器前端设置一个负载均衡器（一般是专门的硬件设备）
- 负载均衡5个目标：
1. 可扩展性
2. 高效率：负载均衡可以控制请求被路由到何处
3. 可用性：灵活的负载均衡方案可以使用时刻保持可用的服务器
4. 透明性：客户端无感知
5. 一致性：如果应用是有状态的（数据库事务、网站会话等），负载均衡器自动将查询指向同一个服务器防止状态丢失，应用无需跟踪
#### 直接连接
#### 引入中间件
#### 一主多备间的负载均衡