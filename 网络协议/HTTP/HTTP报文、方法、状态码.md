## HTTP报文结构
![TCP头部](pic/HTTP%E6%8A%A5%E6%96%87%E3%80%81%E6%96%B9%E6%B3%95%E3%80%81%E7%8A%B6%E6%80%81%E7%A0%811.png)
- 源端口号和目的端口号：再加上Ip首部的源IP地址和目的IP地址可以唯一确定一个TCP连接<p>
- 数据序号：表示在这个报文段中的第一个数据字节序号<p>
- 确认序号：仅当ACK标志为1时有效。确认号表示期望收到的下一个字节的序号（这个下面再详细分析）<p>
- 偏移：就是头部长度，有4位，跟IP头部一样，以4字节为单位。最大是60个字节<p>
- 保留位：6位，必须为0<p>
- 6个标志位：<p>
URG-紧急指针有效<p>
ACK-确认序号有效<p>
PSH-接收方应尽快将这个报文交给应用层<p>
RST-连接重置<p>
SYN-同步序号用来发起一个连接<p>
FIN-终止一个连接<p>
- 窗口字段：16位，代表的是窗口的字节容量，也就是TCP的标准窗口最大为2^16 - 1 = 65535个字节（这个下面再详细分析）<p>
- 校验和：源机器基于数据内容计算一个数值，收信息机要与源机器数值 结果完全一样，从而证明数据的有效性。检验和覆盖了整个的TCP报文段：这是一个强制性的字段，一定是由发送端计算和存储，并由接收端进行验证的。<p>
- 紧急指针：是一个正偏移量，与序号字段中的值相加表示紧急数据最后一个字节的序号。TCP的紧急方式是发送端向另一端发送紧急数据的一种方式<p>
- 选项与填充（必须为4字节整数倍，不够补0）：<p>
最常见的可选字段的最长报文大小MSS（Maximum Segment Size），每个连接方通常都在一个报文段中指明这个选项。它指明本端所能接收的最大长度的报文段。<p>
该选项如果不设置，默认为536（20+20+536=576字节的IP数据报）
![HTTP结构](pic/HTTP%E6%8A%A5%E6%96%87%E3%80%81%E6%96%B9%E6%B3%95%E3%80%81%E7%8A%B6%E6%80%81%E7%A0%812.png)
- HTTP是纯文本协议，所以头数据都是ASCII文本
- HTTP协议请求报文和响应报文结构基本相同，包括
1. 起始行（start line）：描述请求或者响应的基本信息
2. 头部字段集合（header）：使用key-value形式更加详细说明报文
3. 消息正文（entity）：实际传输的数据，不一定是纯文本，可以是图片、视频等二进制数据

- 1，2经常合称为请求头或者响应头，消息正文又称为实体（body）
- HTTP协议规定报文必须有header，但可以没有body，header之后必须有一个空行，即“CRLF”，十六进制的“0D0A”
![image](pic/HTTP%E6%8A%A5%E6%96%87%E3%80%81%E6%96%B9%E6%B3%95%E3%80%81%E7%8A%B6%E6%80%81%E7%A0%813.png)
样例
![请求头](pic/HTTP%E6%8A%A5%E6%96%87%E3%80%81%E6%96%B9%E6%B3%95%E3%80%81%E7%8A%B6%E6%80%81%E7%A0%814.png)

- 浏览器发送GET请求的时候，经常只有header没有body

#### 请求行
简要描述了客户端想要如何操作服务器的资源，分为3部分
1. 请求方法：一个动词，如GET/POST，表示对资源的操作
2. 请求目标：通常是一个URI，标记请求方法要操作的资源
3. 版本号：表示报文使用的HTTP协议版本
4. 三个部分用空格分隔，最后用CRLF换行表示结束
![请求行实例](pic/HTTP%E6%8A%A5%E6%96%87%E3%80%81%E6%96%B9%E6%B3%95%E3%80%81%E7%8A%B6%E6%80%81%E7%A0%815.png)

```
GET / HTTP/1.1

```
#### 状态行
服务器响应的状态，也有三个部分
1. 版本号：表示报文使用的 HTTP 协议版本；
2. 状态码：一个三位数，用代码的形式表示处理的结果，比如 200 是成功，500 是服务器错误；
3. 原因：作为数字状态码补充，是更详细的解释文字，帮助人理解原因。
![image](pic/HTTP%E6%8A%A5%E6%96%87%E3%80%81%E6%96%B9%E6%B3%95%E3%80%81%E7%8A%B6%E6%80%81%E7%A0%816.png)
```
HTTP/1.1 200 OK
```
```
HTTP/1.1 404 Not Found
```

#### 头部字段
###### 请求头
![image](pic/HTTP%E6%8A%A5%E6%96%87%E3%80%81%E6%96%B9%E6%B3%95%E3%80%81%E7%8A%B6%E6%80%81%E7%A0%817.png)
###### 响应头
![image](pic/HTTP%E6%8A%A5%E6%96%87%E3%80%81%E6%96%B9%E6%B3%95%E3%80%81%E7%8A%B6%E6%80%81%E7%A0%818.png)
- 头部字段是 key-value 的形式，key 和 value 之间用“:”分隔，最后用 CRLF 换行表示字段结束。比如在“Host: 127.0.0.1”这一行里 key 就是“Host”，value 就是“127.0.0.1”。
- HTTP 头字段非常灵活，不仅可以使用标准里的 Host、Connection 等已有头，也可以任意添加自定义头，这就给 HTTP 协议带来了无限的扩展可能。
- 注意事项
1. 字段名不区分大小写，例如“Host”也可以写成“host”，但首字母大写的可读性更好；
2. 字段名里不允许出现空格，可以使用连字符“-”，但不能使用下划线“_”。例如，“test-name”是合法的字段名，而“test name”“test_name”是不正确的字段名；
3. 字段名后面必须紧接着“:”，不能有空格，而“:”后的字段值前可以有多个空格；
4. 字段的顺序是没有意义的，可以任意排列不影响语义；
5. 字段原则上不能重复，除非这个字段本身的语义允许，例如 Set-Cookie。

#### 常用头部字段
分为四大类：
1. 通用字段：在请求头和响应头里都可以出现；
2. 请求字段：仅能出现在请求头里，进一步说明请求信息或者额外的附加条件；
3. 响应字段：仅能出现在响应头里，补充说明响应报文的信息；
4. 实体字段：它实际上属于通用字段，但专门描述 body 的额外信息。
具体字段解释
1. Host字段：告诉服务器请求应该由哪个主机处理。当一个计算机上托管了多个虚拟主机，服务器端用Host字段选择
2. User_Agent：只出现在请求头里，用一个自渡船描述HTTP请求的客户端，服务器可以根据它返回最合适的页面内容
3. Date：通用字段，但通常出现在响应头里，表示HTTP报文创建的时间，客户端可以使用这个时间再搭配其他字段决定缓存策略
4. Server：响应字段。告诉客户端当前正在提供web服务的软件名称和版本号，如“Server: openresty/1.15.8.1”，即使用的是 OpenResty 1.15.8.1。尽量使用无关信息，因为会暴露信息给外界，容易受到攻击
![响应头案例](pic/HTTP%E6%8A%A5%E6%96%87%E3%80%81%E6%96%B9%E6%B3%95%E3%80%81%E7%8A%B6%E6%80%81%E7%A0%819.png)

5. Content-Length：表示报文里body的长度，也就是请求头或者响应头空行后的数据的长度；如果没有这个字段，body则不定长，需要使用chunked方式分段传输



## 请求方法
目前，HTTP规定了8种方法：
1. GET：获取资源，可以理解为读取或者下载数据；
2. HEAD：获取资源的元信息；
3. POST：向资源提交数据，相当于写入或上传数据；
4. PUT：类似 POST；
5. DELETE：删除资源；
6. CONNECT：建立特殊的连接隧道；
7. OPTIONS：列出可对资源实行的方法；
8. TRACE：追踪请求 - 响应的传输路径。
![HTTP全部方法](pic/HTTP%E6%8A%A5%E6%96%87%E3%80%81%E6%96%B9%E6%B3%95%E3%80%81%E7%8A%B6%E6%80%81%E7%A0%8110.png)

如果一个文件不允许访问，可以有下面几种方式
1. 直接404，说文件不存在
2. 403 forbidden，提示无权限访问
3. 405 method not allowed，并用allow头告诉你可以用head方法获取文件信息


#### GET/HEAD方法
- GET方法使用最多，含义是从服务器获取资源（静态文本、页面、图片、视频或其他格式的数据）
- GET方法比较简单，搭配URI和其他头字段能实现对资源的精细操作
- HEAD方法与GET方法类似，但只传回响应头，就是资源的“元信息”，可以看做GET方法的轻量版


#### POST/PUT 
- POST和PUT方法相反操作，向指定的URI提交数据，数据在报文的body里
- POST频率仅次于GET，向服务器发送数据，大多数是POST
- PUT方法和POST很类似，有的服务器甚至禁止PUT


#### 其他方法
- DELETE：指示服务器删除资源，危险性太大，所以通常服务器不会执行真正的删除操作，而是对资源做一个删除标记。更多的时候服务器就直接不处理 DELETE 请求。
- CONNECT：是一个比较特殊的方法，要求服务器为客户端和另一台远程服务器建立一条特殊的连接隧道，这时 Web 服务器在中间充当了代理的角色。
- OPTIONS：要求服务器列出可对资源实行的操作方法，在响应头的 Allow 字段里返回。它的功能很有限，用处也不大，有的服务器（例如 Nginx）干脆就没有实现对它的支持。
- TRACE：方法多用于对 HTTP 链路的测试或诊断，可以显示出请求 - 响应的传输路径。它的本意是好的，但存在漏洞，会泄漏网站的信息，所以 Web 服务器通常也是禁止使用。

#### 扩展方法
可以任意添加请求动作，只要请求方和响应方都能理解就行

#### 安全与幂等
- 安全是指”是指请求方法不会“破坏”服务器上的资源，即不会对服务器上的资源造成实质的修改。GET 和 HEAD是安全的，其余方法如POST、PUT、DELETE等都是不安全的
- 幂等”实际上是一个数学用语，被借用到了 HTTP 协议里，意思是多次执行相同的操作，结果也都是相同的，即多次“幂”后结果“相等”。POST是新增或者提交数据，多次提交会创建多个资源，不幂等；PUT是替换或者更新数据，多次更新一个资源，资源还是第一次更新的状态，所以是幂等的

## 响应状态码
分为5类：
- 1XX：提示信息，表示目前是处理的中间状态，还需要后续操作
- 2XX：成功，报文已经收到且被正确处理
- 3XX：重定向，资源位置发生变动，需要客户端重新发送请求
- 4XX：客户端错误，请求报文有误，服务器无法处理
- 5XX：服务器错误，服务器在处理请求时发生内部错误

状态大类|状态码| 解释
---|---|---
1XX|101 Switching Protocols|它的意思是客户端使用 Upgrade 头字段<p>要求在HTTP协议的基础上改成其他的协议继续通信，比如WebSocket<p>而如果服务器也同意变更协议，就会发送状态码101，但这之后的数据传输就不会再使用 HTTP 了。
2XX|200 OK|是最常见的成功状态码，服务器如客户端所期望的那样返回了处理结果，如果是非 HEAD 请求，通常在响应头后都会有 body 数据
2XX|204 No Content|它的含义与“200 OK”基本相同，但响应头后没有 body 数据
2XX|206 Partial Content|它与 200 一样，也是服务器成功处理了请求，但 body 里的数据是资源的一部分。状态码 206 通常还会伴随着头字段“Content-Range”
3XX|301 Moved Permanently|俗称“永久重定向”，资源已经不存在了，需要改用新的 URI 再次访问。
3XX|302 Found（Moved Temporarily）|俗称“临时重定向”，意思是请求的资源还在，但需要暂时用另一个 URI 来访问。
3XX|304 Not Modified|表示资源未修改，用于缓存控制
4XX|400 Bad Request|表示请求报文有错误，但具体是数据格式错误、缺少请求头还是 URI 超长它没有明确说，只是一个笼统的错误，应少用
4XX|403 Forbidden|表示服务器禁止访问资源。原因可能多种多样，例如信息敏感、法律禁止等
4XX|404 Not Found|常被滥用
4XX|405 Method Not Allowed|不允许使用某些方法操作资源，例如不允许 POST 只能 GET；
4XX|406 Not Acceptable|资源无法满足客户端请求的条件，例如请求中文但只有英文；
4XX|408 Request Timeout|请求超时，服务器等待了过长的时间；
4XX|409 Conflict|多个请求发生了冲突，可以理解为多线程并发时的竞态；
4XX|413 Request Entity Too Large|请求报文里的 body 太大；
4XX|414 Request-URI Too Long|请求行里的 URI 太大；
4XX|429 Too Many Requests|客户端发送了太多的请求，通常是由于服务器的限连策略；
4XX|431 Request Header Fields Too Large|请求头某个字段或总体太大；
5XX|500 Internal Server Error|与 400 类似，也是一个通用的错误码，服务器究竟发生了什么错误我们是不知道的
5XX|501 Not Implemented|表示客户端请求的功能还不支持
5xx|502 Bad Gateway|通常是服务器作为网关或者代理时返回的错误码，表示服务器自身工作正常，访问后端服务器时发生了错误，但具体的错误原因也是不知道的。
5xx|503 Service Unavailable|表示服务器当前很忙，暂时无法响应服务；是一个“临时”的状态，很可能过几秒钟后可以继续提供服务，所以 503响应报文里通常还会有一个“Retry-After”字段


## HTTP特点
![HTTP特点](pic/HTTP%E6%8A%A5%E6%96%87%E3%80%81%E6%96%B9%E6%B3%95%E3%80%81%E7%8A%B6%E6%80%81%E7%A0%8111.png)
- 优点：
1. 简单、灵活、易于扩展
2. 应用广泛、环境成熟
- 中性特点
1. 无状态（实现简单，但实现一些状态操作比较麻烦）
2. 明文（简单，但不安全）
- 缺点
1. 不安全
2. 性能不算差但不够好
