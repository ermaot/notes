python对于打开文件和关闭文件的操作，普遍建议使用with语句，语法如下：

```
with expresssion [as 目标]:
	代码块
```

with也可以嵌套

## 语句执行原理

	1.	计算表达式的值，返回一个上下文管理器对象
 	2.	加载上下文管理器对象的\_\_exit\_\_()方法以后备用
 	3.	调用上下文管理器的\_\_enter_\_()方法
 	4.	如果with语句中设置了目标对象，则将\_\_enter\_\_()方法的返回值复制给目标对象
 	5.	执行with中的代码块
 	6.	如果步骤5中代码正常结束，则调用上下文管理器对象的\_\_exit\_\_()方法，其返回值直接忽略
 	7.	如果步骤5中执行发生异常，则调用上下文管理器对象的\_\_exit\_\_()方法，并将异常类型、值、traceback信息作为参数传递给\_\_exit\_\_()方法。如果\_\_exit\_\_()返回false，则异常重新被抛出；如果返回为true，异常被挂起，程序继续执行

## 上下文管理器

可以看到，with的神奇之处来自上下文管理器（context manager），它可以创建一个运行时环境。它定义程序运行时需要建立的上下文，处理程序进入和退出，实现上下文管理协议，即在对象中定义\_\_enter\_\_()和\_\_exit\_\_()方法

1. \_\_enter\_\_()：进入运行时的上下文，返回运行时上下文相关对象
2. \_\_exit\_\_(exception_type,exception_value,traceback)：退出运行时的上下文，定义在块执行之后上下文管理器应该做什么。比如处理异常、清理现场或者处理任何所需动作

任何实现了上下文协议的对象都可以成为上下文管理器